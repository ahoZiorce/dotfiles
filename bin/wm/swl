#!/bin/sh

bspc subscribe all | while read -r line; do

evt="${line%% *}"
l="${line##* }"
wl="${line% *}"
bl="${wl##* }"

case "$evt" in
	node_add)
		echo "Window $l created"
		pid="$(xprop -id $l | grep -oP 'WM_PID.*?\K[0-9]+')"
		[ -z "$pid" ] && continue
		echo "$l pid is $pid"
		eval "id$pid='$l' ; win$l='$pid'"
		ppid="$(pstree -T -p $pid -s | grep -oP 'st\(\K[0-9]+' | tail -2 | head -1)"
		[ -z "$ppid" ] || [ "$ppid" = "$pid" ] && continue
		eval "pwid=\$id$ppid"
		echo "Parent terminal id is $ppid, that is, window $pwid"
		;;
	node_remove)
		echo "Window $l removed"
		eval "t=\$win$l"
		eval "id$t= ; win$l="
		;;
esac

done
